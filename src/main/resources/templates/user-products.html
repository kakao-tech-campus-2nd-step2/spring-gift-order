<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Products</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2>상품 목록</h2>
    <div class="row" id="product-list">
        <!-- Products will be dynamically inserted here -->
    </div>
</div>
<div id="pagination" class="mt-3 text-center">
    <button id="prev-page" class="btn btn-secondary" disabled>Previous</button>
    <span id="current-page">1</span>
    <button id="next-page" class="btn btn-secondary">Next</button>
</div>
<a href="/view/home">Back to Home</a>

<!-- Modal -->
<div class="modal fade" id="orderModal" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderModalLabel">Order Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="order-form">
                    <div class="form-group">
                        <label for="order-message">Enter a message for your order:</label>
                        <input type="text" class="form-control" id="order-message" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Order</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        let currentPage = 1;
        const pageSize = 9;
        let productId;
        let currentOptionId;
        let currentQuantity;

        function getEmailFromToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('You need to log in first.');
                return null;
            }

            try {
                const decodedToken = jwt_decode(token);
                return decodedToken.sub;  // 이메일을 sub 필드에서 추출합니다.
            } catch (error) {
                console.error('Error decoding token:', error);
                alert('Failed to decode token. Please log in again.');
                return null;
            }
        }

        function fetchProducts(page, size) {
            $.ajax({
                url: `/view/products/data?page=${page - 1}&size=${size}`, // Spring Data JPA는 페이지 번호가 0부터 시작
                method: 'GET',
                success: function(response) {
                    const products = response.content;
                    const productList = $('#product-list');
                    productList.empty(); // 기존 제품 목록을 지웁니다.

                    if (products.length === 0 && page > 1) {
                        currentPage--;
                        updatePagination(currentPage, response.pagination.totalPages);
                        return;
                    }

                    products.forEach(product => {
                        const options = product.options.map(option => `<option value="${option.id}" data-quantity="${option.quantity}">${option.name} (Quantity: ${option.quantity})</option>`).join('');

                        const quantityOptions = Array.from({length: 5}, (v, i) => i + 1)
                            .map(num => `<option value="${num}">${num}</option>`).join('');

                        const productCard = `
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <img class="card-img-top" src="${product.imageUrl}" alt="${product.name}">
                                    <div class="card-body">
                                        <h5 class="card-title">${product.name}</h5>
                                        <h6 class="card-category">${product.categoryName}</h6>
                                        <p class="card-text">${product.description}</p>

                                        <select class="form-control mb-2 option-select">
                                            <option value="" disabled selected>-- Select Option --</option>
                                            ${options}
                                        </select>

                                        <select class="form-control mb-2 quantity-select">
                                            <option value="" disabled selected>-- Select Quantity --</option>
                                            ${quantityOptions}
                                        </select>

                                        <button class="btn btn-primary add-to-wishlist" data-id="${product.id}">Add to Wishlist</button>
                                        <button class="btn btn-success order-item" data-id="${product.id}">Order Item</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        productList.append(productCard);
                    });

                    // Add to wishlist functionality
                    $('.add-to-wishlist').click(function() {
                        const productId = $(this).data('id');
                        const email = getEmailFromToken();
                        if (!email) return;

                        $.ajax({
                            url: `/api/wishlist/${productId}`,
                            method: 'POST',
                            data: {
                                email: email
                            },
                            success: function() {
                                alert('Product added to wishlist!');
                            },
                            error: function() {
                                alert('Failed to add product to wishlist.');
                            }
                        });
                    });

                    // order item functionality
                    $('.order-item').click(function() {
                        productId = $(this).data('id');
                        const selectedOption = $(this).siblings('.option-select').find('option:selected');
                        currentOptionId = selectedOption.val();
                        currentQuantity = $(this).siblings('.quantity-select').val();

                        if (!currentOptionId || !currentQuantity) {
                            alert('Please select an option and quantity.');
                            return;
                        }

                        $('#orderModal').modal('show');
                    });

                    // Order form submit
                    $('#order-form').submit(function(event) {
                        event.preventDefault();
                        const email = getEmailFromToken();
                        const orderMessage = $('#order-message').val();

                        if (!email) return;

                        $.ajax({
                            url: `/api/products/order/${productId}`,
                            method: 'POST',
                            data: {
                                email: email,
                                optionId: currentOptionId,
                                quantity: currentQuantity,
                                message: orderMessage
                            },
                            success: function() {
                                alert('Product ordered successfully!');
                                $('#orderModal').modal('hide');
                            },
                            error: function() {
                                alert('Failed to order product.');
                            }
                        });
                    });

                    // Pagination 상태 업데이트
                    updatePagination(page, response.pagination.totalPages);
                },
                error: function() {
                    alert('Failed to fetch products.');
                }
            });
        }

        function updatePagination(currentPage, totalPages) {
            $('#current-page').text(currentPage.toString());
            $('#prev-page').prop('disabled', currentPage <= 1);
            $('#next-page').prop('disabled', currentPage >= totalPages);
        }

        // 초기 로드
        fetchProducts(currentPage, pageSize);

        // 페이지 이동 버튼 클릭 이벤트
        $('#prev-page').click(function() {
            if (currentPage > 1) {
                currentPage--;
                fetchProducts(currentPage, pageSize);
            }
        });

        $('#next-page').click(function() {
            currentPage++;
            fetchProducts(currentPage, pageSize);
        });
    });

</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>
</html>
