# spring-gift-order

## 1단계
### 카카오 로그인 후, 토큰 발급 요청 후 토큰을 받아오는 API를 구현한다.

#### 첫번째 작업: 로그인 html 작성
- 해당 페이지에서 클라이언트가 카카오 로그인 버튼을 클릭
- 우리 서버가 로그인 요청을 카카오 서버에게 전송
- GET /oauth/authorize
- 클라이언트는 카카오계정 로그인 요청 화면을 반환받게 됨
#### 두번째 작업: 클라이언트가 카카오 로그인 요청
- 우리 서버를 거치지 않고 카카오 서버 내에서 로그인 검증
- 동의 항목 출력 및 클라이언트의 동의 항목 체크
- 기존에 설정해둔 redirect-uri로 인가코드를 우리 서버에 응답 (상태 코드 302)
#### 세번째 작업: 카카오 서버로부터 얻어온 인가코드와 클라이언트 정보 등을 기반으로 카카오 서버에 토큰 발급을 요청하여 토큰 받아오기
- redirect_uri에서 requestMapping
  - redirect_uri: http://localhost:8080/kakao/login/oauth2/code
  - 카카오 서버로부터 오는 것이기 때문에, 별도의 행위 메서드 표기 없이 requestMapping으로 처리
- POST /oauth/token
- 최종적으로 토큰 반환 (상태 코드 200)

## 2단계
### 상품 주문 시, 주문 내역을 카카오톡 메시지로 전송한다. (나에게 보내기)

#### 토큰 관리
- 우리 서비스용 토큰, 카카오용 토큰 2개가 존재
- 클라이언트 <-> 우리 서버: 전자 사용
- 우리 서버 <-> 카카오 서버: 후자 사용
- 카카오 토큰을 별도의 DB에 저장 
- 우리 서비스용 토큰에는 해당 카카오 토큰을 참조할 수 있는 참조키 값을 넣어둠

#### 로그인 시 동작
1) 카카오 로그인으로 카카오 액세스 토큰을 받아온다.
2) 카카오 사용자 정보 가져오기 API로 해당 유저의 정보를 받아온다. (카카오 유저 id)
3) 유저 정보를 활용하여 우리 서비스에 가입된 회원 여부를 검사한다.
4) 우리 서비스의 회원이라면, 로그인 처리 후 우리 서비스 토큰을 넣어서 반환한다.
   우리 서비스의 회원이 아니라면, 회원 가입 처리 후 우리 서비스 토큰을 넣어서 반환한다.
5) 카카오 토큰은 <Long memberId, String token> 형태로 별도의 저장소에 저장해둔다.

#### Orders
- order_id
- member_id (외래키만 참조)
- option (다대일 연관관계 매핑)
- quantity: 주문 수량
  - 1개~1억개의 수량 입력 가능함
- message: 주문 시 메시지
  - 0자~100자 입력 가능함

#### OrderService
- 주문 생성
  - 옵션에서 수량 차감(OptionService.subtractQuantity())
  - 해당 옵션의 상품이 위시 리스트에 존재하는 경우 위시 리스트에서 삭제
  - 주문 save 및 response 데이터 반환

#### OrderApiController
- 주문 요청
  - Order 생성 및 수량 차감 처리
  - 카카오 메시지 API로 메시지 전송

#### 주문 시 동작
1) 클라이언트가 우리 서비스 토큰을 넣어 주문 요청을 보낸다.
2) 우리 서버에서 주문을 처리한다. (옵션 수량 차감, 카카오 토큰 획득)
3) 카카오 서버로 카카오 토큰을 넣어 카카오톡 메시지 API를 호출한다.
4) 클라이언트에게 주문 내역 메시지가 전송된다.


## 3단계
### Spring Rest Docs를 활용한 API 문서 작성 자동화
#### Product API
  - 전체 상품 조회
  - 상품 + 전체 옵션 조회
  - 상품 + 단일 옵션 조회
  - 상품 추가
  - 상품 수정
  - 상품 삭제
#### Category API
  - 전체 카테고리 조회
  - 카테고리 조회
  - 카테고리 추가
  - 카테고리 수정
  - 카테고리 삭제
#### Options API
  - 옵션 추가
  - 옵션 수정
  - 옵션 삭제
#### Order API
  - 주문 생성 및 메시지 전송
  - 주문 조회
#### WishList API
  - 위시리스트 조회
  - 위시 추가
  - 위시 삭제
#### Login API
  - 회원가입
  - 로그인
#### oAuth2 Login API
  - oAuth2 인증 및 토큰 반환
